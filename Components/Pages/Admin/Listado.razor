@page "/admin/listado"
@layout EmptyLayout
@attribute [Authorize(Roles = "user_admin,UsuarioEstandar")]
@using Microsoft.AspNetCore.Authorization
@using REGISTROLEGAL.Components.Layout
@using Microsoft.EntityFrameworkCore
@using REGISTROLEGAL.Models.Entities.BdSisLegal
@using REGISTROLEGAL.Repositories.Interfaces
@inject DbContextLegal _context
@inject NavigationManager NavigationManager
@inject IRegistroComite ComiteService

<PageTitle>Listado</PageTitle>

<div class="container mt-5">
    <div class="card shadow border-0 rounded-4">
        <div class="card-header bg-primary text-white rounded-top-4 py-3 d-flex justify-content-between align-items-center">
            <h4 class="mb-0 fw-bold">
                <i class="bi bi-collection me-2"></i> Listados del Sistema
            </h4>
            <NavLink class="btn btn-secondary" href="/Dashboard" Match="NavLinkMatch.All">
                <i class="fa-solid fa-arrow-left me-1"></i> Volver
            </NavLink>
        </div>

        <div class="card-body bg-light">
            <!-- Selector de tipo -->
            <div class="row align-items-center mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-semibold text-secondary">
                        <i class="bi bi-funnel"></i> Seleccione qué desea ver:
                    </label>
                    <select class="form-select"
                            @bind="tipoSeleccionado"
                            @bind:after="async () => await CargarDatos()">
                        <option value="">-- Seleccione --</option>
                        <option value="Comites">Comités</option>
                        <option value="Asociaciones">Asociaciones</option>
                    </select>
                </div>

                <!-- Botón dinámico -->
                @if (!string.IsNullOrEmpty(tipoSeleccionado))
                {
                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                        <button class="btn btn-success shadow-sm fw-semibold px-4"
                                @onclick="IrARegistro">
                            <i class="bi bi-plus-circle me-2"></i>
                            Registrar @(tipoSeleccionado == "Comites" ? "Comité" : "Asociación")
                        </button>
                    </div>
                }
            </div>

            <!-- Barra de búsqueda dinámica -->
            @if (!string.IsNullOrEmpty(tipoSeleccionado))
            {
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="position-relative">
                            <label class="form-label fw-semibold text-secondary">
                                <i class="bi bi-search me-1"></i> 
                                Buscar @(tipoSeleccionado == "Comites" ? "Comité" : "Asociación")
                            </label>
                            <input type="text"
                                   class="form-control"
                                   placeholder="Escriba para buscar..."
                                   @bind="textoBusqueda"
                                   @bind:event="oninput"
                                   @onkeyup="HandleSearchKeyUp" />
                            
                            <!-- Sugerencias para Comités -->
                            @if (tipoSeleccionado == "Comites" && sugerenciasComites?.Any() == true && !string.IsNullOrEmpty(textoBusqueda))
                            {
                                <div class="position-absolute w-100 bg-white border mt-1 rounded shadow-lg z-3" style="max-height: 250px; overflow-y: auto;">
                                    @foreach (var sugerencia in sugerenciasComites)
                                    {
                                        <div class="p-2 border-bottom hover-bg"
                                             @onclick="() => SeleccionarSugerenciaComite(sugerencia)"
                                             style="cursor: pointer;">
                                            <div class="fw-semibold">@sugerencia.NombreComiteSalud</div>
                                            <small class="text-muted">@sugerencia.Comunidad - @sugerencia.NumeroResolucion</small>
                                        </div>
                                    }
                                </div>
                            }
                            
                            <!-- Sugerencias para Asociaciones -->
                            @if (tipoSeleccionado == "Asociaciones" && sugerenciasAsociaciones?.Any() == true && !string.IsNullOrEmpty(textoBusqueda))
                            {
                                <div class="position-absolute w-100 bg-white border mt-1 rounded shadow-lg z-3" style="max-height: 250px; overflow-y: auto;">
                                    @foreach (var sugerencia in sugerenciasAsociaciones)
                                    {
                                        <div class="p-2 border-bottom hover-bg"
                                             @onclick="() => SeleccionarSugerenciaAsociacion(sugerencia)"
                                             style="cursor: pointer;">
                                            <div class="fw-semibold">@sugerencia.NombreAsociacion</div>
                                            <small class="text-muted">Folio: @sugerencia.Folio - @sugerencia.NumeroResolucion</small>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                    
                    <!-- Contador de resultados -->
                    <div class="col-md-6 d-flex align-items-end justify-content-end">
                        @if (!string.IsNullOrEmpty(textoBusqueda))
                        {
                            <span class="badge bg-info fs-6">
                                @GetResultCount() resultado(s) encontrado(s)
                            </span>
                        }
                    </div>
                </div>
            }

            <!-- Tabla de Comités -->
            @if (tipoSeleccionado == "Comites" && comitesFiltrados?.Any() == true)
            {
                <h5 class="text-success mb-3">
                    <i class="bi bi-people-fill me-2"></i>Listado de Comités
                    @if (!string.IsNullOrEmpty(textoBusqueda))
                    {
                        <span class="badge bg-secondary fs-6">(Filtrado)</span>
                    }
                </h5>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered align-middle bg-white">
                        <thead class="table-primary">
                        <tr>
                            <th>Nombre del Comité</th>
                            <th>Comunidad</th>
                            <th>N° Resolución</th>
                            <th>Fecha de Creación</th>
                            <th class="text-center">Acción</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var c in comitesFiltrados)
                        {
                            <tr>
                                <td>@c.NombreComiteSalud</td>
                                <td>@c.Comunidad</td>
                                <td>@c.NumeroResolucion</td>
                                <td>@c.FechaRegistro?.ToString("dd/MM/yyyy")</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-primary"
                                            title="Editar Comité"
                                            @onclick="() => EditarComite(c.ComiteId)">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
            else if (tipoSeleccionado == "Comites" && !cargando && (comitesFiltrados == null || !comitesFiltrados.Any()))
            {
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle"></i> 
                    @(string.IsNullOrEmpty(textoBusqueda) ? "No hay comités registrados." : "No se encontraron comités con ese criterio de búsqueda.")
                </div>
            }

            <!-- Tabla de Asociaciones -->
            @if (tipoSeleccionado == "Asociaciones" && asociacionesFiltradas?.Any() == true)
            {
                <h5 class="text-success mb-3">
                    <i class="bi bi-building-fill me-2"></i>Listado de Asociaciones
                    @if (!string.IsNullOrEmpty(textoBusqueda))
                    {
                        <span class="badge bg-secondary fs-6">(Filtrado)</span>
                    }
                </h5>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered align-middle bg-white">
                        <thead class="table-primary">
                        <tr>
                            <th>Nombre de la Asociación</th>
                            <th>Folio</th>
                            <th>N° Resolución</th>
                            <th>Fecha de Resolución</th>
                            <th class="text-center">Acción</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var a in asociacionesFiltradas)
                        {
                            <tr>
                                <td>@a.NombreAsociacion</td>
                                <td>@a.Folio</td>
                                <td>@a.NumeroResolucion</td>
                                <td>@a.FechaResolucion?.ToString("dd/MM/yyyy")</td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary"
                                                title="Editar Asociación"
                                                @onclick="() => EditarAsociacion(a.AsociacionId)">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning"
                                                title="Cambio de Miembros"
                                                @onclick="() => CambioMiembrosAsociacion(a.AsociacionId)">
                                            <i class="bi bi-people-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
            else if (tipoSeleccionado == "Asociaciones" && !cargando && (asociacionesFiltradas == null || !asociacionesFiltradas.Any()))
            {
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle"></i> 
                    @(string.IsNullOrEmpty(textoBusqueda) ? "No hay asociaciones registradas." : "No se encontraron asociaciones con ese criterio de búsqueda.")
                </div>
            }

            @if (cargando)
            {
                <div class="alert alert-info mt-3">
                    <i class="bi bi-hourglass-split"></i> Cargando información...
                </div>
            }

            <!-- Mensaje inicial -->
            @if (string.IsNullOrEmpty(tipoSeleccionado) && !cargando)
            {
                <div class="alert alert-secondary mt-3">
                    <i class="bi bi-info-circle"></i> Seleccione una opción para mostrar los registros.
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string? tipoSeleccionado;
    private string textoBusqueda = string.Empty;
    private bool cargando = false;
    
    // Datos completos
    private List<TbComite>? comites;
    private List<TbAsociacion>? asociaciones;
    
    // Datos filtrados
    private List<TbComite>? comitesFiltrados;
    private List<TbAsociacion>? asociacionesFiltradas;
    
    // Sugerencias para autocomplete
    private List<TbComite>? sugerenciasComites;
    private List<TbAsociacion>? sugerenciasAsociaciones;

    protected override void OnInitialized()
    {
        tipoSeleccionado = null;
    }

    private async Task CargarDatos()
    {
        if (string.IsNullOrEmpty(tipoSeleccionado))
        {
            comites = null;
            asociaciones = null;
            comitesFiltrados = null;
            asociacionesFiltradas = null;
            textoBusqueda = string.Empty;
            return;
        }

        cargando = true;
        StateHasChanged();

        try
        {
            if (tipoSeleccionado == "Comites")
            {
                comites = await _context.TbComite
                    .OrderByDescending(c => c.FechaRegistro)
                    .ToListAsync();
                comitesFiltrados = comites;
                asociaciones = null;
                asociacionesFiltradas = null;
            }
            else if (tipoSeleccionado == "Asociaciones")
            {
                asociaciones = await _context.TbAsociacion
                    .OrderByDescending(a => a.FechaResolucion)
                    .ToListAsync();
                asociacionesFiltradas = asociaciones;
                comites = null;
                comitesFiltrados = null;
            }
            
            // Limpiar búsqueda anterior
            textoBusqueda = string.Empty;
            sugerenciasComites = null;
            sugerenciasAsociaciones = null;
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private async Task HandleSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await FiltrarDatos();
        }
        else
        {
            await MostrarSugerencias();
        }
    }

    private async Task MostrarSugerencias()
    {
        if (string.IsNullOrEmpty(textoBusqueda) || textoBusqueda.Length < 2)
        {
            sugerenciasComites = null;
            sugerenciasAsociaciones = null;
            return;
        }

        var searchTerm = textoBusqueda.ToLower();

        if (tipoSeleccionado == "Comites" && comites != null)
        {
            sugerenciasComites = comites
                .Where(c => (c.NombreComiteSalud?.ToLower().Contains(searchTerm) == true) ||
                           (c.Comunidad?.ToLower().Contains(searchTerm) == true) ||
                           (c.NumeroResolucion?.ToLower().Contains(searchTerm) == true))
                .Take(10)
                .ToList();
        }
        else if (tipoSeleccionado == "Asociaciones" && asociaciones != null)
        {
            sugerenciasAsociaciones = asociaciones
                .Where(a => (a.NombreAsociacion?.ToLower().Contains(searchTerm) == true) ||
                           (a.NumeroResolucion?.ToLower().Contains(searchTerm) == true) ||
                           (a.Folio.ToString().Contains(searchTerm)))
                .Take(10)
                .ToList();
        }

        StateHasChanged();
    }

    private async Task FiltrarDatos()
    {
        if (string.IsNullOrEmpty(textoBusqueda))
        {
            // Si no hay texto de búsqueda, mostrar todos los datos
            if (tipoSeleccionado == "Comites")
                comitesFiltrados = comites;
            else if (tipoSeleccionado == "Asociaciones")
                asociacionesFiltradas = asociaciones;
        }
        else
        {
            var searchTerm = textoBusqueda.ToLower();

            if (tipoSeleccionado == "Comites" && comites != null)
            {
                comitesFiltrados = comites
                    .Where(c => (c.NombreComiteSalud?.ToLower().Contains(searchTerm) == true) ||
                               (c.Comunidad?.ToLower().Contains(searchTerm) == true) ||
                               (c.NumeroResolucion?.ToLower().Contains(searchTerm) == true) ||
                               (c.NumeroNota?.ToLower().Contains(searchTerm) == true))
                    .ToList();
            }
            else if (tipoSeleccionado == "Asociaciones" && asociaciones != null)
            {
                asociacionesFiltradas = asociaciones
                    .Where(a => (a.NombreAsociacion?.ToLower().Contains(searchTerm) == true) ||
                               (a.NumeroResolucion?.ToLower().Contains(searchTerm) == true) ||
                               (a.Actividad?.ToLower().Contains(searchTerm) == true) ||
                               (a.Folio.ToString().Contains(searchTerm)))
                    .ToList();
            }
        }

        sugerenciasComites = null;
        sugerenciasAsociaciones = null;
        StateHasChanged();
    }

    private void SeleccionarSugerenciaComite(TbComite comite)
    {
        textoBusqueda = comite.NombreComiteSalud ?? string.Empty;
        comitesFiltrados = new List<TbComite> { comite };
        sugerenciasComites = null;
        StateHasChanged();
    }

    private void SeleccionarSugerenciaAsociacion(TbAsociacion asociacion)
    {
        textoBusqueda = asociacion.NombreAsociacion ?? string.Empty;
        asociacionesFiltradas = new List<TbAsociacion> { asociacion };
        sugerenciasAsociaciones = null;
        StateHasChanged();
    }

    private string GetResultCount()
    {
        return tipoSeleccionado switch
        {
            "Comites" => comitesFiltrados?.Count.ToString() ?? "0",
            "Asociaciones" => asociacionesFiltradas?.Count.ToString() ?? "0",
            _ => "0"
        };
    }

    private void IrARegistro()
    {
        if (tipoSeleccionado == "Comites")
            NavigationManager.NavigateTo($"/tramites/personeria");
        else if (tipoSeleccionado == "Asociaciones")
            NavigationManager.NavigateTo($"/formulario/registro-asociacion");
    }

    private void EditarComite(int id)
    {
        NavigationManager.NavigateTo($"/comites/editcomite/{id}");
    }

    private void EditarAsociacion(int id)
    {
        NavigationManager.NavigateTo($"/asociaciones/editasociacion/{id}");
    }
    
    private void CambioMiembrosAsociacion(int id)
    {
        NavigationManager.NavigateTo($"/asociaciones/cambio-miembros/{id}");
    }
}

<style>
    .hover-bg:hover {
        background-color: #f8f9fa !important;
    }
    
    .z-3 {
        z-index: 1030;
    }
</style>