@page "/comites/registrar"
@using REGISTROLEGAL.DTOs
@using REGISTROLEGAL.Repositories.Interfaces
@inject IRegistroService RegistroService
@inject IUbicacionService UbicacionService
@inject NavigationManager Navigation

<EditForm Model="@Model" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary Class="alert alert-danger mb-3" />

    @if (!string.IsNullOrEmpty(MensajeExito))
    {
        <div class="alert alert-success">@MensajeExito</div>
    }

    @if (!string.IsNullOrEmpty(MensajeError))
    {
        <div class="alert alert-danger">@MensajeError</div>
    }

    @if (IsLoading)
    {
        <div class="alert alert-info">Cargando...</div>
    }

    <h3 class="mb-4 text-primary">Registro de Comité</h3>

    <!-- DATOS DEL COMITÉ -->
    <fieldset class="border p-3 mb-4 bg-light">
        <legend class="w-auto px-2">Información del Comité</legend>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Nombre del Comité *</label>
                <InputText @bind="Model.NombreComiteSalud" class="form-control" />
                <ValidationMessage For="@(() => Model.NombreComiteSalud)" class="text-danger small" />
            </div>

            <div class="col-md-6 mb-3">
                <label>Comunidad</label>
                <InputText @bind="Model.Comunidad" class="form-control" />
            </div>

            <div class="col-md-6 mb-3">
                <label>Fecha de Creación</label>
                <InputDate @bind="Model.FechaCreacionComite" class="form-control" />
            </div>
        </div>
    </fieldset>

    <!-- UBICACIÓN -->
    <fieldset class="border p-3 mb-4 bg-light">
        <legend class="w-auto px-2">Ubicación Geográfica</legend>
        <div class="row">
            <div class="col-md-3 mb-3">
                <label>Región *</label>
                <InputSelect @bind="Model.RegionSaludId" @onchange="@(async e => await CargarProvincias(e))" class="form-control">
                    <option value="0">-- Seleccione --</option>
                    @foreach (var region in Regiones)
                    {
                        <option value="@region.RegionSaludId">@region.NombreRegion</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => Model.RegionSaludId)" class="text-danger small" />
            </div>

            <div class="col-md-3 mb-3">
                <label>Provincia *</label>
                <InputSelect @bind="Model.ProvinciaId" @onchange="@(async e => await CargarDistritos(e))" class="form-control">
                    <option value="0">-- Seleccione --</option>
                    @foreach (var provincia in Provincias)
                    {
                        <option value="@provincia.ProvinciaId">@provincia.NombreProvincia</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => Model.ProvinciaId)" class="text-danger small" />
            </div>

            <div class="col-md-3 mb-3">
                <label>Distrito *</label>
                <InputSelect @bind="Model.DistritoId" @onchange="@(async e => await CargarCorregimientos(e))" class="form-control">
                    <option value="0">-- Seleccione --</option>
                    @foreach (var distrito in Distritos)
                    {
                        <option value="@distrito.DistritoId">@distrito.NombreDistrito</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => Model.DistritoId)" class="text-danger small" />
            </div>

            <div class="col-md-3 mb-3">
                <label>Corregimiento *</label>
                <InputSelect @bind="Model.CorregimientoId" class="form-control">
                    <option value="0">-- Seleccione --</option>
                    @foreach (var corregimiento in Corregimientos)
                    {
                        <option value="@corregimiento.CorregimientoId">@corregimiento.NombreCorregimiento</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => Model.CorregimientoId)" class="text-danger small" />
            </div>
        </div>
    </fieldset>

    <!-- TRÁMITE -->
    <div class="form-group mb-4">
        <label>Tipo de Trámite *</label>
        <InputSelect @bind="Model.TipoTramiteId" @onchange="@(async e => await OnTramiteChanged(e))" class="form-control">
            <option value="0">-- Seleccione --</option>
            @foreach (var tramite in TipoTramites)
            {
                <option value="@tramite.TramiteId">@tramite.NombreTramite</option>
            }
        </InputSelect>
        <ValidationMessage For="@(() => Model.TipoTramiteId)" class="text-danger small" />
    </div>

    <!-- MIEMBROS -->
    @if (Model.TipoTramiteId > 0)
    {
        <fieldset class="border p-3 mb-4 bg-light">
            <legend class="w-auto px-2">Miembros del Comité</legend>

            @if (Model.TipoTramiteId == 3)
            {
                <div class="alert alert-info">
                    Solo se permiten 2 miembros: Presidente y Tesorero.
                </div>
            }

            @for (int i = 0; i < Model.Miembros.Count; i++)
            {
                var miembro = Model.Miembros[i];
                <div class="card mb-2" @key="miembro">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label>Nombre *</label>
                                <InputText @bind="miembro.Nombre" class="form-control" />
                                <ValidationMessage For="@(() => miembro.Nombre)" class="text-danger small" />
                            </div>

                            <div class="col-md-4">
                                <label>Cédula *</label>
                                <InputText @bind="miembro.Cedula" class="form-control" />
                                <ValidationMessage For="@(() => miembro.Cedula)" class="text-danger small" />
                            </div>

                            <div class="col-md-4">
                                <label>Cargo *</label>
                                <InputSelect @bind="miembro.CargoId" class="form-control">
                                    @foreach (var cargo in CargosDisponibles)
                                    {
                                        <option value="@cargo.CargoId">@cargo.NombreCargo</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <button type="button" class="btn btn-secondary btn-sm" @onclick="AddMiembro" disabled="@IsMaxMiembros()">
                + Añadir Miembro
            </button>
        </fieldset>
    }

    <!-- DOCUMENTOS -->
    <fieldset class="border p-3 mb-4 bg-light">
        <legend class="w-auto px-2">Documentos</legend>
        <div class="mb-3">
            <label>Subir documentos</label>
            <InputFile @ref="fileInput" OnChange="@CargarDocumentos" multiple class="form-control" />
        </div>

        @if (Model.DocumentosSubir?.Count > 0)
        {
            <ul class="list-group">
                @for (int i = 0; i < Model.DocumentosSubir.Count; i++)
                {
                    var archivo = Model.DocumentosSubir[i];
                    <li class="list-group-item d-flex justify-content-between" @key="archivo.Name">
                        <span>@archivo.Name (@(Math.Round(archivo.Size / 1024.0, 2)) KB)</span>
                        <button class="btn btn-sm btn-danger" @onclick="() => RemoverDocumento(i)">Eliminar</button>
                    </li>
                }
            </ul>
        }
    </fieldset>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary" disabled="@IsSubmitting">
            @(IsSubmitting ? "Guardando..." : "Guardar")
        </button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar" disabled="@IsSubmitting">Cancelar</button>
    </div>
</EditForm>

@code {

}